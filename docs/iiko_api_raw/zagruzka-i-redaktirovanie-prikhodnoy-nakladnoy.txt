Загрузка и редактирование приходной накладной

  

    

  
Content-Type: application/xml
Что в ответе
Пример запроса и результата 

  
  

  

Версия iiko:         3.9 (редактирование с 5.2)       
  
    
	
        
      	
        
https://host:port/resto/api/documents/import/incomingInvoice
      
    
  

Content-Type: application/xml

Тело запроса

Формат даты по полям метода загрузки приходной накладной:
<dateIncoming>dd.mm.YYYY</dateIncoming>
<dueDate>dd.mm.YYYY</dueDate>
<incomingDate>YYYY-mm-dd</incomingDate>

  

    [+]
    
      XSD Приходная накладная
    
  
  

    [-]
    
      XSD Приходная накладная
    
  
  

     
	
Copy Code
XML
	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<xs:schema version="1.0" xmlns:xs="http://www.w3.org/2001/XMLSchema">
    <xs:element name="document" type="incomingInvoiceDto"/>
 
    <xs:complexType name="incomingInvoiceDto">
        <xs:sequence>
            <!--Позиции документа-->
            <xs:element name="items" minOccurs="0">
                <xs:complexType>
                    <xs:sequence>
                        <xs:element name="item" type="incomingInvoiceItemDto" minOccurs="0" maxOccurs="unbounded"/>
                    </xs:sequence>
                </xs:complexType>
            </xs:element>
            <!--
            Id документа (только чтение)
            @since 5.4
            -->
            <xs:element name="id" type="xs:string" minOccurs="0"/>
            <!--Концепция (guid)-->
            <xs:element name="conception" type="xs:string" minOccurs="0"/>
            <!--
            Код концепции.
            @since 7.8
            -->
            <xs:element name="conceptionCode" type="xs:string" minOccurs="0"/>
            <!--Комментарий-->
            <xs:element name="comment" type="xs:string" minOccurs="0"/>
            <!--Учетный номер документа-->
            <xs:element name="documentNumber" type="xs:string" minOccurs="0"/>
            <!--
            Дата документа.
            Поддерживаемые форматы: dd.MM.yyyy
            -->
            <xs:element name="dateIncoming" type="xs:string" minOccurs="0"/>
            <!--Номер счет-фактуры.-->
            <xs:element name="invoice" type="xs:string" minOccurs="0"/>
            <!--Склад. Если указан, то в каждой позиции накладной нужно указать этот же склад.-->
            <xs:element name="defaultStore" type="xs:string" minOccurs="0"/>
            <!--Поставщик-->
            <xs:element name="supplier" type="xs:string" minOccurs="0"/>
            <!--
            Срок оплаты.
            Поддерживаемые форматы: dd.MM.yyyy
            -->
            <xs:element name="dueDate" type="xs:string" minOccurs="0"/>
            <!--
            Входящая дата внешнего документа в формате yyyy-MM-dd.
            Если при импорте не указана, то берется из dateIncoming.
            @since 7.6.1
            -->
            <xs:element name="incomingDate" type="xs:string" minOccurs="0"/>
            <!--
            false (по умолчанию): использовать переданные дату-время dateIncoming как есть.
            true: использовать настройки проведения документов, заданные в подразделении:
             * В режиме "текущее время" - дату и время из dateIncoming;
             * "фиксированное время" или "время закрытия кассовой смены" - дату из dateIncoming, а время из настроек.
            @since 5.2
            -->
            <xs:element name="useDefaultDocumentTime" type="xs:boolean" minOccurs="0" default="false"/>
            <xs:element name="status" type="documentStatus" minOccurs="0"/>
            <!--Входящий номер внешнего документа-->
            <xs:element name="incomingDocumentNumber" type="xs:string" minOccurs="0"/>
            <!--Сотрудник (поле "зачесть сотруднику" на форме накладной)-->
            <xs:element name="employeePassToAccount" type="xs:string" minOccurs="0"/>
            <!--Номер товарно-транспортной накладной-->
            <xs:element name="transportInvoiceNumber" type="xs:string" minOccurs="0"/>
            <!--
            UUID связанной расходной накладной
            (только чтение)
            @since 5.4
            -->
            <xs:element name="linkedOutgoingInvoiceId" type="xs:string" minOccurs="0"/>
             
            <!--
            Алгоритм распределения дополнительных расходов.
            (только чтение)
            @since 6.0
            -->
            <xs:element name="distributionAlgorithm" type="distributionAlgorithmType" minOccurs="0"/>
        </xs:sequence>
    </xs:complexType>
 
    <!--Позиция документа-->
    <xs:complexType name="incomingInvoiceItemDto">
        <xs:sequence>
            <!--
            Является дополнительным расходом
            (только чтение)
            @since 6.0
            -->
            <xs:element name="isAdditionalExpense" type="xs:boolean" minOccurs="0" default="false"/>
             <!--Количество товара в его основных единицах измерения-->
            <xs:element name="amount" type="xs:decimal" minOccurs="0"/>
            <!--Товар у поставщика (guid)-->
            <xs:element name="supplierProduct" type="xs:string" minOccurs="0"/>
            <!--Товар у поставщика (артикул). Можно задать вместо guid начиная с 5.0.-->
            <xs:element name="supplierProductArticle" type="xs:string" minOccurs="0"/>
            <!--Товар (guid). Хотя бы одно из полей должно быть заполнено: product или productArticle.-->
            <xs:element name="product" type="xs:string" minOccurs="0"/>
            <!--Товар (артикул). Можно задать вместо guid товара начиная с 5.0, guid имеет приоритет.-->
            <xs:element name="productArticle" type="xs:string" minOccurs="0"/>
            <!--Производитель/импортер. Должен содержаться в списке производителей/импортеров в карточке товара:
            Товар - Дополнительная информация - Акогольная декларация - Производитель/Импортер-->
            <xs:element name="producer" type="xs:string" minOccurs="0"/>
            <!--Номер позиции в документе. Обязательное поле.-->
            <xs:element name="num" type="xs:int" minOccurs="1"/>
            <!--Фасовка (guid)-->
            <xs:element name="containerId" type="xs:string" minOccurs="0"/>
            <!--Базовая единица измерения (guid)-->
            <xs:element name="amountUnit" type="xs:string" minOccurs="0"/>
            <!--Вес единицы измерения-->
            <!--!!! Не реализовано !!!-->
            <xs:element name="actualUnitWeight" type="xs:decimal" minOccurs="0"/>
            <!--
            Cумма строки без учета скидки.
            Как правило sum == amount * price / container + discountSum + vatSum
             -->
            <xs:element name="sum" type="xs:decimal" minOccurs="1"/>
            <!--Cумма скидки-->
            <!--!!! Не реализовано !!!-->
            <xs:element name="discountSum" type="xs:decimal" minOccurs="0"/>
            <!--
            Величина процента НДС и сумма НДС для строки документа.
            Если не задана сумма, она вычисляется по проценту.
            Если не задан процент, он берется из карточки товара.
            Нельзя задать только сумму, не задавая процент.
            @since 5.0
            -->
            <xs:element name="vatPercent" type="xs:decimal" minOccurs="0"/>
            <xs:element name="vatSum" type="xs:decimal" minOccurs="0"/>
            <!--Цена единицы измерения-->
            <xs:element name="priceUnit" type="xs:string" minOccurs="0"/>
            <!--Цена за ед.-->
            <xs:element name="price" type="xs:decimal" minOccurs="0"/>
            <!--
            Цена без НДС за фасовку с учетом скидки
            @since 6.2
            -->
            <xs:element name="priceWithoutVat" type="xs:decimal" minOccurs="0"/>
            <!--Код-->
            <!--!!! Не реализовано !!!-->
            <xs:element name="code" type="xs:string" minOccurs="0"/>
            <!--Склад-->
            <xs:element name="store" type="xs:string" minOccurs="0"/>
            <!--Номер государственной таможенной декларации-->
            <xs:element name="customsDeclarationNumber" type="xs:string" minOccurs="0"/>
            <!--Фактическое (подтвержденное) количество основных единиц товара-->
            <xs:element name="actualAmount" type="xs:decimal" minOccurs="0"/>
        </xs:sequence>
    </xs:complexType>
 
    <xs:simpleType name="documentStatus">
        <xs:restriction base="xs:string">
            <xs:enumeration value="NEW"/>
            <xs:enumeration value="PROCESSED"/>
            <xs:enumeration value="DELETED"/>
        </xs:restriction>  
    </xs:simpleType>
     
    <xs:simpleType name="distributionAlgorithmType">
        <xs:restriction base="xs:string">
            <xs:enumeration value="DISTRIBUTION_BY_SUM"/>
            <xs:enumeration value="DISTRIBUTION_BY_AMOUNT"/>
            <xs:enumeration value="DISTRIBUTION_NOT_SPECIFIED"/>
        </xs:restriction>
    </xs:simpleType>
</xs:schema>
  

Что в ответе

Структура documentValidationResult 

  

  

    [+]
    
      XSD Результат валидации документа
    
  
  

    [-]
    
      XSD Результат валидации документа
    
  
  

     
	
Copy Code
XML
	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<xs:schema version="1.0" xmlns:xs="http://www.w3.org/2001/XMLSchema">
    <xs:element name="documentValidationResult" type="documentValidationResult"/>
 
    <!--
    Результат валидации документа.
    Некоторые документы возвращают более подробную информацию, смотрите:
     * incomingInventoryValidationResult.xsd
    -->
    <xs:complexType name="documentValidationResult">
        <xs:sequence>
            <!-- Результат валидации. -->
            <xs:element name="valid" type="xs:boolean"/>
            <!-- Указывает на то, что ошибка не критичная и служит в качестве предупреждения. -->
            <xs:element name="warning" type="xs:boolean"/>
            <!-- Номер валидируемого документа. -->
            <xs:element name="documentNumber" type="xs:string" minOccurs="0"/>
            <!--
            Новый номер для документа.
            Отличен от null, если старый нарушает уникальность или не изменились влияющие на номер поля.
            -->
            <xs:element name="otherSuggestedNumber" type="xs:string" minOccurs="0"/>
            <!--
            Текст ошибки (или только заголовок, если задано additionalInfo).
            Предназначен для показа пользователю, но в REST API не всегда локализован.
            -->
            <xs:element name="errorMessage" type="xs:string" minOccurs="0"/>
            <!--
            Для невалидного результата может быть указана дополнительная информация, содержащая детали ошибки.
            Например, для случая списания в минус это поле содержит детальную информацию по каждой позиции документа,
            приводящей к отрицательным остаткам.
            -->
            <xs:element name="additionalInfo" type="xs:string" minOccurs="0"/>
        </xs:sequence>
    </xs:complexType>
</xs:schema>
  

Пример расчета количества и цены товара: 

   При формировании приходной накладной есть позиция с продуктом в ящиках с базовыми единицами в кг. 

   

Например, 5 ящиков по 1000 руб каждый, и в каждом ящике по 10 кг. Тогда заполнятся следующие поля:
"в ед." (<amount>) - 5*10= 50
"Фактическое количество" (<actualAmount>)  - 5*10=50/documents/export/incomingInvoice
"Цена базовой единицы" (<price>) - 1000/10=100 
   Если фасовки нет, то эти поля заполняются количеством товара в единицах измерения.

  Пример запроса и результата

  Запрос

https://localhost:8080/resto/api/documents/import/incomingInvoice?key=ddb22676-38a7-afb4-d02a-d5f6898d64cc 

	
Copy Code
XML
	

<document>
  <items>
    <item>
      <amount>3.00</amount>
      <supplierProduct>BF1DA0F2-B511-431E-BC7D-F2A68715054B</supplierProduct>
      <product>0F22AA60-E8AE-4C8E-80CD-F1E00B88FEC6</product>
      <num>1</num>
      <containerId>00000000-0000-0000-0000-000000000000</containerId>
      <amountUnit>6040D92D-E286-F4F9-A613-ED0E6FD241E1</amountUnit>
      <actualUnitWeight/>
      <discountSum>0.00</discountSum>
      <sumWithoutNds>30.00</sumWithoutNds>
      <ndsPercent>0.00</ndsPercent>
      <sum>30.00</sum>
      <priceUnit/>
      <price>10.00</price>
      <code>25753</code>
      <store>1239d270-1bbe-f64f-b7ea-5f00518ef508</store>
      <customsDeclarationNumber>cdn-7</customsDeclarationNumber>
      <actualAmount>3.00</actualAmount>
    </item>
  <item>
      <amount>4.00</amount>
      <supplierProduct>18C66E42-9A71-402A-81B0-A0DAA8E74F4B</supplierProduct>
      <product>B2D954CE-FC7A-44FF-9987-35AF59F16966</product>
      <num>2</num>
      <containerId>00000000-0000-0000-0000-000000000000</containerId>
      <amountUnit>6040D92D-E286-F4F9-A613-ED0E6FD241E1</amountUnit>
      <actualUnitWeight/>
      <discountSum>0.00</discountSum>
      <sumWithoutNds>80.00</sumWithoutNds>
      <ndsPercent>0.00</ndsPercent>
      <sum>80.00</sum>
      <priceUnit/>
      <price>20.00</price>
      <code>25752</code>
      <store>1239d270-1bbe-f64f-b7ea-5f00518ef508</store>
      <customsDeclarationNumber>cdn-7</customsDeclarationNumber>
      <actualAmount>4.00</actualAmount>
    </item>
  </items>
  <conception>2609B25F-2180-BF98-5C1C-967664EEA837</conception>
  <comment>comment-7</comment>
  <documentNumber>dn-7</documentNumber>
  <dateIncoming>17.12.2014</dateIncoming>
  <useDefaultDocumentTime>true</useDefaultDocumentTime>
  <invoice>in-7</invoice>
  <defaultStore>1239d270-1bbe-f64f-b7ea-5f00518ef508</defaultStore>
  <supplier>3F08E41C-AA25-4573-B1E0-60B3B8A09F6A</supplier>
  <dueDate>27.12.2014</dueDate>
  <incomingDocumentNumber>idn-7</incomingDocumentNumber>
  <employeePassToAccount>9e1a4e13-f811-4dea-94b4-575b2cf0f2f8</employeePassToAccount>
  <transportInvoiceNumber>tin-7</transportInvoiceNumber>
</document>
   
 

  Результат

   
	
Copy Code
XML
	HTTP/1.1 200 OK
Server: Apache-Coyote/1.1 
Vary: Accept-Encoding
Content-Type: application/xml 
Content-Length: 188
Date: Wed, 17 Dec 2014 11:27:26 GMT 
<?xml version="1.0" encoding="UTF-8" standalone="yes"?> 
<documentValidationResult> 
  <documentNumber>dn-7</documentNumber>  
  <valid>true</valid> 
  <warning>false</warning>
</documentValidationResult>